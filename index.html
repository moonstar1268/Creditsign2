<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CreditSign</title>
  <link rel="stylesheet" href="styles.css">

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdn.emailjs.com/sdk/latest/email.min.js"></script>

  <style>
    #pdf-preview canvas { border:1px solid #ccc; margin-bottom:10px; }
    .hidden { display:none; }
    #name-img, #signature-img {
      position:absolute; cursor:move; border:1px solid #333;
      width:150px;
    }
    button {
      transform: scale(1, 1.5);
    }
  </style>
</head>
<body>
  <h1>CreditSign</h1>

  <br><br>

  <button id="name-add">이름 입력</button>
  <button id="open-pad">➕ 서명 추가</button>
  <button id="download">⬇️ 서명된 문서 다운로드</button>

  <div id="pdf-preview"></div>

  <div id="pad-wrapper" class="hidden">
    <canvas id="sig-canvas" width="400" height="200"></canvas><br/>
    <button id="clear">Clear</button>
    <button id="save-sig">Save</button>
  </div>

  <footer style="margin-top:20px;font-size:14px;color:#666;">
    Copyright (C) 한국금융범죄예방연구센터. All rights reserved.
  </footer>

<script>
emailjs.init("e91b6FwpgpxBYA76r"); // EmailJS Public Key 입력

const pdfUrl = "크레딧사인 기본세팅 1.pdf";
let pdfBytes = null;

async function loadDefaultPDF() {
  const res = await fetch(pdfUrl);
  pdfBytes = await res.arrayBuffer();
  const wrap = document.getElementById("pdf-preview");
  wrap.innerHTML = "";
  const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const vp = page.getViewport({ scale: 1.0 });
    const canvas = document.createElement("canvas");
    canvas.width = vp.width;
    canvas.height = vp.height;
    await page.render({ canvasContext: canvas.getContext("2d"), viewport: vp }).promise;
    wrap.appendChild(canvas);
  }
}

window.onload = loadDefaultPDF;

// PDF 다운로드 및 이메일 발송 처리
document.getElementById("download").onclick = async () => {
  const blob = new Blob([pdfBytes], { type: "application/pdf" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "signed_document.pdf";
  a.click();

  const reader = new FileReader();
  reader.onloadend = function() {
    const base64data = reader.result;

    emailjs.send("service_v5hek3f", "template_8u7pmwc", {
      pdf_link: base64data,
      to_email: "moonstar1268@kaist.ac.kr"
    })
    .then(() => alert("PDF가 이메일로 전송되었습니다."))
    .catch(err => alert("이메일 전송 실패: " + err));
  };
  reader.readAsDataURL(blob);
};
</script>
</body>
</html>
