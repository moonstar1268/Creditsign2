<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CreditSign</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- PDF & Signature libs -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <!-- EmailJSâ€†Â·â€†Firebase ì´ˆê¸°í™” -->
  <script>
    /* EmailJS */
    (function () {
      emailjs.init({ publicKey: "e91b6FwpgpxBYA76r" });
    })();

    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyCFHoGUSSV_XYcdx5j-lk7POD7DpK0DBzA",
      authDomain: "creditsign-4cd56.firebaseapp.com",
      projectId: "creditsign-4cd56",
      storageBucket: "creditsign-4cd56.appspot.com",
      messagingSenderId: "850755768885",
      appId: "1:850755768885:web:d1162aa3b0a181f330177c",
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
  </script>

  <style>
    #pdf-preview canvas { border:1px solid #ccc; margin-bottom:10px; }
    .hidden { display:none; }
    #name-img, #signature-img {
      position:absolute; cursor:move; border:1px solid #333; width:150px;
    }
  </style>
</head>
<body>
  <h1>CreditSign</h1>

  <button id="form1-tab">ì»¨ì„¤íŒ… ì˜ë¢°</button>
  <button id="form2-tab">íšŒì›ê°€ì… ì‹ ì²­</button>
  <br><br>

  <button id="name-add">ì´ë¦„ ì…ë ¥</button>
  <button id="open-pad">â• ì„œëª… ì¶”ê°€</button>
  <button id="download">â¬‡ï¸ ì„œëª…ëœ ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ</button>

  <div id="pdf-preview"></div>

  <div id="pad-wrapper" class="hidden">
    <canvas id="sig-canvas" width="400" height="200"></canvas><br/>
    <button id="clear">Clear</button>
    <button id="save-sig">Save</button>
  </div>

  <footer style="margin-top:20px;font-size:14px;color:#666;">
    Copyright (C) í•œêµ­ê¸ˆìœµë²”ì£„ì˜ˆë°©ì—°êµ¬ì„¼í„°. All rights reserved.
  </footer>

<script>
/* ---------------------------- PDF ë¡œë”© ---------------------------- */
const pdfUrls = {
  "ì»¨ì„¤íŒ… ì˜ë¢°": "í¬ë ˆë”§ì‚¬ì¸ ê¸°ë³¸ì„¸íŒ… 1.pdf",
  "íšŒì›ê°€ì… ì‹ ì²­": "í¬ë ˆë”§ì‚¬ì¸ ê¸°ë³¸ì„¸íŒ… 2.pdf"
};

let pdfBytes=null, padType="", nameInfo={page:null,dataURL:null}, sigInfo={page:null,dataURL:null};

async function loadDefaultPDF(name){
  const res = await fetch(pdfUrls[name]);
  pdfBytes = await res.arrayBuffer();
  nameInfo={page:null,dataURL:null}; sigInfo={page:null,dataURL:null};
  clearElements();
  const wrap=document.getElementById("pdf-preview"); wrap.innerHTML="";
  const pdf = await pdfjsLib.getDocument({data:pdfBytes}).promise;
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const vp=page.getViewport({scale:1});
    const canvas=document.createElement("canvas");
    canvas.width=vp.width; canvas.height=vp.height;
    canvas.dataset.page=i-1;
    canvas.onclick=e=>onCanvasClick(e,canvas);
    await page.render({canvasContext:canvas.getContext("2d"),viewport:vp}).promise;
    wrap.appendChild(canvas);
  }
}
function clearElements(){
  document.querySelectorAll("#name-img,#signature-img").forEach(el=>el.remove());
  document.getElementById("pad-wrapper").classList.add("hidden");
}

/* ------------- ì´ë¦„/ì„œëª… ë°°ì¹˜ ------------- */
function onCanvasClick(e,canvas){
  const pageIndex=Number(canvas.dataset.page);
  const [px,py]=[e.pageX,e.pageY];
  if(padType==="name") placeImage("name-img",nameInfo,pageIndex,px,py);
  else if(padType==="sig") placeImage("signature-img",sigInfo,pageIndex,px,py);
}
function placeImage(id,info,page,x,y){
  document.getElementById(id)?.remove();
  const img=document.createElement("img"); img.id=id; img.src=info.dataURL;
  img.style.left=x+"px"; img.style.top=y+"px"; document.body.appendChild(img);
  makeDraggable(img); info.page=page;
}

/* ------------- ë²„íŠ¼ í•¸ë“¤ëŸ¬ ------------- */
document.getElementById("form1-tab").onclick=()=>loadDefaultPDF("ì»¨ì„¤íŒ… ì˜ë¢°");
document.getElementById("form2-tab").onclick=()=>loadDefaultPDF("íšŒì›ê°€ì… ì‹ ì²­");
document.getElementById("name-add").onclick=()=>{padType="name";openPad();};
document.getElementById("open-pad").onclick=()=>{padType="sig";openPad();};

function openPad(){document.getElementById("pad-wrapper").classList.remove("hidden");initSignaturePad();}
function initSignaturePad(){
  const canvas=document.getElementById("sig-canvas");
  if(!window.signaturePad){
    window.signaturePad=new SignaturePad(canvas);
    document.getElementById("clear").onclick=()=>signaturePad.clear();
    document.getElementById("save-sig").onclick=()=>{
      if(signaturePad.isEmpty()){alert(padType==="name"?"ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”":"ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”");return;}
      const du=signaturePad.toDataURL();
      if(padType==="name") nameInfo.dataURL=du; else sigInfo.dataURL=du;
      document.getElementById("pad-wrapper").classList.add("hidden");
      alert(padType==="name"?"ì´ë¦„ ë°°ì¹˜í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”":"ì„œëª… ë°°ì¹˜í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”");
    };
  }else signaturePad.clear();
}
function makeDraggable(el){
  el.onmousedown=e=>{
    const rect=el.getBoundingClientRect(); const [sx,sy]=[e.clientX-rect.left,e.clientY-rect.top];
    document.onmousemove=ev=>{el.style.left=ev.pageX-sx+"px";el.style.top=ev.pageY-sy+"px";};
    document.onmouseup=()=>{document.onmousemove=document.onmouseup=null;};
  };
}

/* ------------- ë‹¤ìš´ë¡œë“œ & Firebase ì—…ë¡œë“œ ------------- */
document.getElementById("download").onclick=async()=>{
  if(!pdfBytes){alert("PDFë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");return;}

  const pdfDoc=await PDFLib.PDFDocument.load(pdfBytes);
  const pages=pdfDoc.getPages(); const canvases=document.querySelectorAll("#pdf-preview canvas");

  const embed=async(info,id)=>{
    if(!info.dataURL||info.page===null) return;
    const imgEl=document.getElementById(id); const canvasEl=canvases[info.page]; const page=pages[info.page];
    const cRect=canvasEl.getBoundingClientRect(); const iRect=imgEl.getBoundingClientRect();
    const scaleX=page.getWidth()/cRect.width, scaleY=page.getHeight()/cRect.height;
    const x=(iRect.left-cRect.left)*scaleX;
    const y=page.getHeight()-(iRect.top-cRect.top)*scaleY-iRect.height*scaleY;
    const png=await pdfDoc.embedPng(info.dataURL);
    page.drawImage(png,{x,y,width:iRect.width*scaleX,height:iRect.height*scaleY});
  };
  await embed(nameInfo,"name-img"); await embed(sigInfo,"signature-img");

  const pdfBytesOut=await pdfDoc.save();
  const blob=new Blob([pdfBytesOut],{type:"application/pdf"});
  const filename=`signed_${Date.now()}.pdf`;
  try{
    /* Firebase ì—…ë¡œë“œ */
    const snapshot=await storage.ref().child(`signed_docs/${filename}`).put(blob);
    const downloadURL=await snapshot.ref.getDownloadURL();
    console.log("ğŸ“¦ Firebase downloadURL:",downloadURL);

    /* ì¦‰ì‹œ ë‹¤ìš´ë¡œë“œ */
    const a=document.createElement("a");a.href=downloadURL;a.download=filename;document.body.appendChild(a);a.click();a.remove();

    /* EmailJS ì „ì†¡ */
    await emailjs.send("service_v5hek3f","template_8u7pmwc",{to_email:"moonstar1268@kaist.ac.kr",pdf_link:downloadURL});
    alert("âœ… ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ! (Firebase ë§í¬ í¬í•¨)");
  }catch(err){
    console.error(err);alert("âŒ ì—…ë¡œë“œ/ì´ë©”ì¼ ì˜¤ë¥˜: "+err.message);
  }
};

/* ------------------- ì´ˆê¸° ë¡œë”© ------------------- */
window.onload=()=>{
  pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  loadDefaultPDF("ì»¨ì„¤íŒ… ì˜ë¢°");
};
</script>
</body>
</html>
