<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CreditSign</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- PDF & Signature libs -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <script>
    /* EmailJS 초기화 */
    (function () {
      emailjs.init({ publicKey: "e91b6FwpgpxBYA76r" });
    })();

    /* Firebase 초기화 */
    const firebaseConfig = {
      apiKey: "AIzaSyCFHoGUSSV_XYcdx5j-lk7POD7DpK0DBzA",
      authDomain: "creditsign-4cd56.firebaseapp.com",
      projectId: "creditsign-4cd56",
      storageBucket: "creditsign-4cd56.appspot.com",
      messagingSenderId: "850755768885",
      appId: "1:850755768885:web:d1162aa3b0a181f330177c",
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
  </script>

  <style>
    #pdf-preview canvas {
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    .hidden {
      display: none;
    }
    #name-img,
    #signature-img {
      position: absolute;
      cursor: move;
      border: 1px solid #333;
      width: 150px;
    }
  </style>
</head>
<body>
  <h1>CreditSign</h1>

  <button id="form1-tab">컨설팅 의뢰</button>
  <button id="form2-tab">회원가입 신청</button>
  <br /><br />

  <button id="name-add">이름 입력</button>
  <button id="open-pad">➕ 서명 추가</button>
  <button id="download">⬇️ 서명된 문서 다운로드</button>

  <div id="pdf-preview"></div>

  <div id="pad-wrapper" class="hidden">
    <canvas id="sig-canvas" width="400" height="200"></canvas><br />
    <button id="clear">Clear</button>
    <button id="save-sig">Save</button>
  </div>

  <footer style="margin-top: 20px; font-size: 14px; color: #666">
    Copyright (C) 한국금융범죄예방연구센터. All rights reserved.
  </footer>

  <script>
    /* ----------------------------- PDF 로딩 ----------------------------- */
    const pdfUrls = {
      "컨설팅 의뢰": "크레딧사인 기본세팅 1.pdf",
      "회원가입 신청": "크레딧사인 기본세팅 2.pdf",
    };

    let pdfBytes = null;
    let padType = "";
    let nameInfo = { page: null, dataURL: null };
    let sigInfo = { page: null, dataURL: null };

    async function loadDefaultPDF(name) {
      const res = await fetch(pdfUrls[name]);
      pdfBytes = await res.arrayBuffer();
      nameInfo = { page: null, dataURL: null };
      sigInfo = { page: null, dataURL: null };
      clearElements();
      const wrap = document.getElementById("pdf-preview");
      wrap.innerHTML = "";
      const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const vp = page.getViewport({ scale: 1.0 });
        const canvas = document.createElement("canvas");
        canvas.width = vp.width;
        canvas.height = vp.height;
        canvas.dataset.page = i - 1;
        canvas.onclick = (e) => onCanvasClick(e, canvas);
        await page.render({ canvasContext: canvas.getContext("2d"), viewport: vp }).promise;
        wrap.appendChild(canvas);
      }
    }

    function clearElements() {
      document.querySelectorAll("#name-img, #signature-img").forEach((el) => el.remove());
      document.getElementById("pad-wrapper").classList.add("hidden");
    }

    /* ---------------------------- 이미지 배치 --------------------------- */
    function onCanvasClick(e, canvas) {
      const pageIndex = Number(canvas.dataset.page);
      const px = e.pageX,
        py = e.pageY;
      if (padType === "name") {
        placeImage("name-img", nameInfo, pageIndex, px, py);
      } else if (padType === "sig") {
        placeImage("signature-img", sigInfo, pageIndex, px, py);
      }
    }

    function placeImage(id, info, page, x, y) {
      document.getElementById(id)?.remove();
      const img = document.createElement("img");
      img.id = id;
      img.src = info.dataURL;
      img.style.left = x + "px";
      img.style.top = y + "px";
      document.body.appendChild(img);
      makeDraggable(img);
      info.page = page;
    }

    /* ------------------------- 버튼 핸들러 등록 ------------------------- */
    document.getElementById("form1-tab").onclick = () => loadDefaultPDF("컨설팅 의뢰");
    document.getElementById("form2-tab").onclick = () => loadDefaultPDF("회원가입 신청");

    document.getElementById("name-add").onclick = () => {
      padType = "name";
      openPad();
    };
    document.getElementById("open-pad").onclick = () => {
      padType = "sig";
      openPad();
    };

    function openPad() {
      document.getElementById("pad-wrapper").classList.remove("hidden");
      initSignaturePad();
    }

    function initSignaturePad() {
      const canvas = document.getElementById("sig-canvas");
      if (!window.signaturePad) {
        window.signaturePad = new SignaturePad(canvas);
        document.getElementById("clear").onclick = () => signaturePad.clear();
        document.getElementById("save-sig").onclick = () => {
          if (signaturePad.isEmpty()) {
            alert(padType === "name" ? "이름을 입력하세요" : "서명을 입력하세요");
            return;
          }
          const du = signaturePad.toDataURL();
          if (padType === "name") nameInfo.dataURL = du;
          else sigInfo.dataURL = du;
          document.getElementById("pad-wrapper").classList.add("hidden");
          alert(padType === "name" ? "이름 배치할 위치를 클릭하세요" : "서명 배치할 위치를 클릭하세요");
        };
      } else {
        signaturePad.clear();
      }
    }

    function makeDraggable(el) {
      el.onmousedown = (e) => {
        const rect = el.getBoundingClientRect();
        const shiftX = e.clientX - rect.left;
        const shiftY = e.clientY - rect.top;
        document.onmousemove = (ev) => {
          el.style.left = ev.pageX - shiftX + "px";
          el.style.top = ev.pageY - shiftY + "px";
        };
        document.onmouseup = () => {
          document.onmousemove = document.onmouseup = null;
        };
      };
    }

    /* ----------------------- 다운로드 & 이메일 전송 ---------------------- */
    document.getElementById("download").onclick = async () => {
      if (!pdfBytes) {
        alert("❗ PDF가 로드되지 않았습니다. 상단 탭을 눌러 문서를 먼저 불러오세요.");
        return;
      }

      const pdf
