<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CreditSign â€“ íšŒì›ê°€ì… ì‹ ì²­</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- PDF & Signature libs -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <!-- EmailJSÂ·Firebase ì´ˆê¸°í™” -->
  <script>
    /* EmailJS */
    (function () { emailjs.init({ publicKey: "e91b6FwpgpxBYA76r" }); })();

    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyCFHoGUSSV_XYcdx5j-lk7POD7DpK0DBzA",
      authDomain: "creditsign-4cd56.firebaseapp.com",
      projectId: "creditsign-4cd56",
      storageBucket: "creditsign-4cd56.firebasestorage.app",
      messagingSenderId: "850755768885",
      appId: "1:850755768885:web:d1162aa3b0a181f330177c",
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
  </script>

  <style>
    #pdf-preview canvas { border: 1px solid #ccc; margin-bottom: 10px; }
    .hidden { display: none; }
    #name-img,#signature-img { position:absolute; cursor:move; border:1px solid #333; width:150px; }
    button[disabled]{ opacity:.4; cursor:not-allowed; }
  </style>
</head>
<body>
  <h1>CreditSign â€“ íšŒì›ê°€ì… ì‹ ì²­</h1>

  <!-- íƒ­ ì œê±°: ë‹¨ì¼ í¼ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ë²„íŠ¼ ì‚­ì œ -->
  <br />

  <button id="name-add">ì´ë¦„ ì…ë ¥</button>
  <button id="open-pad">â• ì„œëª… ì¶”ê°€</button>
  <button id="download">â¬‡ï¸ ì„œëª…ëœ ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ</button>

  <div id="pdf-preview"></div>

  <div id="pad-wrapper" class="hidden">
    <canvas id="sig-canvas" width="400" height="200"></canvas><br/>
    <button id="clear">Clear</button>
    <button id="save-sig">Save</button>
  </div>

  <footer style="margin-top:20px;font-size:14px;color:#666;">Copyright Â© í•œêµ­ê¸ˆìœµë²”ì£„ì˜ˆë°©ì—°êµ¬ì„¼í„°</footer>

<script>
/* ---------------- PDF ë¡œë”© (íšŒì›ê°€ì… ì‹ ì²­ë§Œ) ---------------- */
const pdfUrl = "í¬ë ˆë”§ì‚¬ì¸ ê¸°ë³¸ì„¸íŒ… 2.pdf"; // íšŒì›ê°€ì… ì‹ ì²­ìš©
let pdfBytes=null, padType="", nameInfo={page:null,dataURL:null}, sigInfo={page:null,dataURL:null};

async function loadPDF(){
  const res = await fetch(pdfUrl);
  pdfBytes = await res.arrayBuffer();
  nameInfo={page:null,dataURL:null}; sigInfo={page:null,dataURL:null};
  clearElements();
  const wrap=document.getElementById("pdf-preview"); wrap.innerHTML="";
  const pdf=await pdfjsLib.getDocument({data:pdfBytes}).promise;
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const vp=page.getViewport({scale:1});
    const canvas=document.createElement("canvas");
    canvas.width=vp.width; canvas.height=vp.height; canvas.dataset.page=i-1;
    canvas.onclick=e=>onCanvasClick(e,canvas);
    await page.render({canvasContext:canvas.getContext("2d"),viewport:vp}).promise;
    wrap.appendChild(canvas);
  }
}
function clearElements(){document.querySelectorAll("#name-img,#signature-img").forEach(el=>el.remove()); document.getElementById("pad-wrapper").classList.add("hidden");}

/* ì´ë¯¸ì§€ ë°°ì¹˜ */
function onCanvasClick(e,canvas){const idx=Number(canvas.dataset.page);const[x,y]=[e.pageX,e.pageY];if(padType==="name")placeImage("name-img",nameInfo,idx,x,y);else if(padType==="sig")placeImage("signature-img",sigInfo,idx,x,y);} 
function placeImage(id,info,page,x,y){document.getElementById(id)?.remove();const img=document.createElement("img");img.id=id;img.src=info.dataURL;img.style.left=x+"px";img.style.top=y+"px";document.body.appendChild(img);makeDraggable(img);info.page=page;}

/* ë²„íŠ¼ í•¸ë“¤ëŸ¬ */
document.getElementById("name-add").onclick=()=>{padType="name";openPad();};
document.getElementById("open-pad").onclick=()=>{padType="sig";openPad();};

function openPad(){document.getElementById("pad-wrapper").classList.remove("hidden");initSignaturePad();}
function initSignaturePad(){const canvas=document.getElementById("sig-canvas");if(!window.signaturePad){window.signaturePad=new SignaturePad(canvas);document.getElementById("clear").onclick=()=>signaturePad.clear();document.getElementById("save-sig").onclick=()=>{if(signaturePad.isEmpty()){alert(padType==="name"?"ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”":"ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”");return;}const du=signaturePad.toDataURL();if(padType==="name")nameInfo.dataURL=du;else sigInfo.dataURL=du;document.getElementById("pad-wrapper").classList.add("hidden");alert(padType==="name"?"ì´ë¦„ ë°°ì¹˜í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”":"ì„œëª… ë°°ì¹˜í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”");};}else signaturePad.clear();}
function makeDraggable(el){el.onmousedown=e=>{const r=el.getBoundingClientRect();const[sx,sy]=[e.clientX-r.left,e.clientY-r.top];document.onmousemove=ev=>{el.style.left=ev.pageX-sx+"px";el.style.top=ev.pageY-sy+"px";};document.onmouseup=()=>{document.onmousemove=document.onmouseup=null;};};}

/* ë‹¤ìš´ë¡œë“œ & ì—…ë¡œë“œ */
const downloadBtn=document.getElementById("download");
downloadBtn.onclick=async()=>{if(downloadBtn.disabled)return;alert("ë¬¸ì„œ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. 10ì´ˆ ì •ë„ ì†Œìš”ë˜ë‹ˆ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");downloadBtn.disabled=true;if(!pdfBytes){alert("PDFë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”");downloadBtn.disabled=false;return;}try{const pdfDoc=await PDFLib.PDFDocument.load(pdfBytes);const pages=pdfDoc.getPages();const canv=document.querySelectorAll("#pdf-preview canvas");const embed=async(info,id)=>{if(!info.dataURL||info.page===null)return;const img=document.getElementById(id);const c=canv[info.page];const page=pages[info.page];const cR=c.getBoundingClientRect();const iR=img.getBoundingClientRect();const sX=page.getWidth()/cR.width,sY=page.getHeight()/cR.height;const x=(iR.left-cR.left)*sX;const y=page.getHeight()-(iR.top-cR.top)*sY-iR.height*sY;const png=await pdfDoc.embedPng(info.dataURL);page.drawImage(png,{x,y,width:iR.width*sX,height:iR.height*sY});};await embed(nameInfo,"name-img");await embed(sigInfo,"signature-img");const bytes=await pdfDoc.save();const blob=new Blob([bytes],{type:"application/pdf"});const filename=`signed_${Date.now()}.pdf`;const snap=await storage.ref().child(`signed_docs/${filename}`).put(blob);const dl=await snap.ref.getDownloadURL();console.log("ğŸ“¦ Firebase URL:",dl);const a=document.createElement("a");a.href=dl;a.download=filename;document.body.appendChild(a);a.click();a.remove();await emailjs.send("service_v5hek3f","template_8u7pmwc",{to_email:"moonstar1268@kaist.ac.kr",pdf_link
